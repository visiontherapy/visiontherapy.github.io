<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hart Chart exercise</title>
  <meta name="darkreader-lock">
  <link rel="stylesheet" href="vision.css" />
  <script src="settings.js"></script>
  <script defer src="metronome.js"></script>
  <style>
    #tapp {
      cursor: pointer;
      display: inline-block;
      padding: 0.1em;
      border: solid 1px green;
      user-select: none;
    }

    #tapp:active {
      border-color: red;
    }

    #bpm {
      width: 3em;
      margin-left: 0.5em;
    }

    #main {
      position: relative;
      --topgap: 4rem;
      /* clamp(2.5rem, 2.5em, 10vh); */
      /* --slotsize: calc(var(--boxsize) / 10); */
      --scale: 1;
      --boxsize: calc(var(--scale) *min(calc(95vh - var(--topgap)), calc(95vw - var(--topgap))));
      --basefont: calc(var(--boxsize) / 13);
      font-family: 'Times New Roman', Times, serif;
      height: var(--boxsize);
      width: var(--boxsize);
      font-size: var(--basefont);
      top: var(--topgap);
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      left: 50%;
      transform: translate(-50%);

      .slot {
        position: relative;
        text-align: center;
        /* grid layout takes care of size */
        /* width: var(--slotsize);
        height: var(--slotsize); */
      }
    }


    #qrplace {
      display: block;
      position: absolute;
      left: 50%;
      transform: translate(-50%);
      top: 0.5em;
    }

    .qrcode {
      display: none;
      padding: 10px;
      background: #fff;
      position: absolute;
      left: 50%;
      transform: translate(-50%);
      top: 1.5em;
    }

    #qrtoggle:checked~.qrcode {
      display: block;
    }

    #boxscale {
      transform: rotate(-90deg);
      position: absolute;
      width: 12rem;
      right: -4rem;
      top: 13rem;
    }
  </style>
  <!-- https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/ -->
  <!-- https://dev.to/murtuzaalisurti/how-to-make-a-qr-code-generator-using-vanilla-javascript-3cla -->
  <script src="qrcode.min.js"></script>
</head>

<body>

  <!-- TODO
  QR code for mobile app to show mini version
 -->

  <div id="controls">
    <div id="settings">*SETTINGS*</div>

    <div><input type="checkbox" class="slider" id="darkmode" checked="checked" /><label for="darkmode">Dark mode</label></div>
    <button id="metronome">metronome</button><br />
    <div id="tapp">TAP</div><input type="text" id="bpm" /><br />

  </div>
  <div id="qrplace"></div>

  <button id="reload">Reload</button>

  <input type="range" id="boxscale" max="1" min="0.3" value="1" step="0.01" />

  <div id="main" data-mark="">
  </div>

  <script>


    let main = document.querySelector("#main");


    document.querySelector("#boxscale").oninput = function (e) {
      console.log(this.value);

      main.style.setProperty('--scale', this.value);
    };


    // const params = new URLSearchParams(window.location.search);

    // let querypattern = params.get("q");
    // console.log(params);
    let querypattern = window.location.hash.replace(/^#/, "");
    querypattern = querypattern.toUpperCase().replace(/[^A-Z]/g, "");
    if (querypattern) {
      // querypattern = 
      showchart(querypattern.split(""));
    } else {
      showchart();
    }



    function showchart(pattern) {
      let txferstring = "";
      main.innerHTML = "";
      let lastchar = "";
      for (let x = 0; x < 10; x++) {
        for (let y = 0; y < 10; y++) {
          let slot = document.createElement("div");
          slot.className = "slot";
          let breakcount;
          // while (nextchar == lastchar) {
          slot.innerText = lastchar = pattern ? pattern.shift() : nextletter(lastchar);
          txferstring += lastchar;
          main.append(slot);
        }
      }

      // return txferstring;
      // if (!pattern) {
      let url = window.location.toString();
      url.replace(/[\?#&].*$/, "");
      let qrstring = url + "#" + txferstring;
      console.log(qrstring);
      getqr(qrstring);
      // }

    }

    function getqr(data) {
      let [w, h] = [250, 250];
      let qrplace = document.querySelector("#qrplace");
      let qrcode = document.createElement("a");
      qrcode.className = "qrcode";
      qrcode.href = data;
      // qrcode.style = `padding:10px;background:#fff;position:absolute;left:50;top:1em;`;
      // let theqrcode = 
      new QRCode(qrcode, {
        text: data,
        width: w,
        height: h,
        colorDark: "#000",
        colorLight: "#fff",
        correctionLovel: QRCode.CorrectLevel.L,
      });
      // console.log(qrcode);


      // input type="checkbox" class="slider" id="darkmode" checked="checked" /><label for="darkmode">Dark mode</label>
      qrplace.innerHTML = `<input type="checkbox" class="slider" id="qrtoggle" /><label for="qrtoggle">QR code</label>`;
      qrplace.append(qrcode);
    }




    function nextletter(lastchar) {
      let alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
      let loopcount = 0;
      let nextchar;
      do {
        nextchar = alpha[Math.floor(Math.random() * alpha.length)];
        // console.log("checking mark",loopcount,nextmark,centerpoint.dataset.mark);
        if (++loopcount > 5) break; // prevent infinite loop when only one mark is available
      } while (nextchar && nextchar == lastchar);
      return nextchar;
    }


    document.querySelector("#reload").onclick = function (e) {
      showchart();
      window.location.hash = "";
    };


  </script>

</body>

</html>