<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hart Chart exercise</title>
  <meta name="darkreader-lock">
  <link rel="stylesheet" href="vision.css" />
  <link rel="stylesheet" href="metronome.css" />
  <script src="settings.js"></script>
  <script defer src="metronome.js"></script>
  <style>
    body {
      --scale: 1;
      --topgap: 2em;
      /* clamp(2.5rem, 2.5em, 10vh); */
      /* --slotsize: calc(var(--boxsize) / 10); */
      --boxsize: min(calc(95vh - var(--topgap)), calc(95vw - var(--topgap)));
      --basefont: calc(var(--boxsize) / 13);
    }

    #main {
      position: relative;
      font-family: 'Times New Roman', Times, serif;
      height: var(--boxsize);
      width: var(--boxsize);
      font-size: var(--basefont);
      margin-top: 1em;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      left: 50%;
      transform-origin: top;
      transform: translate(-50%) scale(var(--scale));

      .slot {
        position: relative;
        text-align: center;
        line-height: var(--basefont);
        /* grid layout takes care of size */
        /* width: var(--slotsize);
        height: var(--slotsize); */
      }
    }


    #qrplace {
      display: inline-block;
      position: relative;
      text-align: center;
      /* left: 50%;
      transform: translate(-50%);
      top: 0.5em; */
    }

    .qrcode {
      display: none;
      padding: 10px;
      background: #fff;
      position: absolute;
      left: 50%;
      transform: translate(-50%);
      top: 1.5em;
      z-index: 1000;
    }

    #qrtoggle:checked~.qrcode {
      display: block;
    }

    #boxscale {
      position: relative;
      top: 1em;
      left: 50%;
      transform: translate(-50%);
      display: table;
    }

    #boxscale::before,
    #boxscale::after {
      content: "A";
      font-size: 100%;
      display: block;
      position: absolute;
      width: 1em;
      height: 1em;
      top: 50%;
      transform: translate(0, -50%);
    }

    #boxscale::before {
      left: -1.5em;
    }

    #boxscale::after {
      font-size: 150%;
      right: -1.5em;
    }




  </style>
  <!-- https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/ -->
  <!-- https://dev.to/murtuzaalisurti/how-to-make-a-qr-code-generator-using-vanilla-javascript-3cla -->
  <script src="qrcode.min.js"></script>
</head>

<body>

  <div id="ctrlbar">
    <div><a href="index.html"><img id="homeicon" src="home.svg" alt="home" /></a></div>

    <div><input type="checkbox" class="slider" id="darkmode" /><label for="darkmode">Dark mode</label></div>


    <div>
      <div id="tapp">TAP</div><input type="text" id="bpm" value="60" />
      <input type="checkbox" id="metrocheck"><label for="metrocheck">
        <svg id="metro_on" xmlns="http://www.w3.org/2000/svg" version="1.0" width="500" height="500" viewBox="0 0 75 75">
          <path d="M39.389,13.769 L22.235,28.606 L6,28.606 L6,47.699 L21.989,47.699 L39.389,62.75 L39.389,13.769z" style="stroke-width:5;stroke-linejoin:round;" />
          <path d="M48,27.6a19.5,19.5 0 0 1 0,21.4M55.1,20.5a30,30 0 0 1 0,35.6M61.6,14a38.8,38.8 0 0 1 0,48.6" style="fill:none;stroke-width:5;stroke-linecap:round" />
        </svg>

        <svg id="metro_off" xmlns="http://www.w3.org/2000/svg" version="1.0" width="500" height="500" viewBox="0 0 75 75" stroke-width="5">
          <path d="m39,14-17,15H6V48H22l17,15z" stroke-linejoin="round" />
          <path d="m49,26 20,24m0-24-20,24" fill="none" stroke-linecap="round" />
        </svg>
      </label>
    </div>


    <div id="qrplace"></div>


    <button id="reload">Reload</button>

  </div>

  <div id="boxscale"><input type="range" id="scale" max="1" min="0.3" value="1" step="0.01" /></div>

  <div id="main" data-mark=""></div>
<div id="codeout"></div>
  <script>


    let main = document.querySelector("#main");


    document.querySelector("input#scale").oninput = function (e) {
      console.log(this.value);

      document.body.style.setProperty('--scale', this.value);
    };


    // const params = new URLSearchParams(window.location.search);

    // let querypattern = params.get("q");
    // console.log(params);
    let querypattern = window.location.hash.replace(/^#/, "");
    querypattern = querypattern.toUpperCase().replace(/[^A-Z]/g, "");
    if (querypattern) {
      // querypattern = 
      showchart(querypattern.split(""));
    } else {
      showchart();
    }



    function showchart(pattern) {
      let txferstring = "";
      main.innerHTML = "";
      let lastchar = "";
      for (let x = 1; x <= 10; x++) {
        for (let y = 1; y <= 10; y++) {
          let slot = document.createElement("div");
          slot.className = "slot";

					slot.id= "slot" + x + "-" + y;
          let breakcount;
          // while (nextchar == lastchar) {
          slot.innerText = lastchar = pattern ? pattern.shift() : nextletter(lastchar);
          txferstring += lastchar;
          main.append(slot);
        }
      }

      // return txferstring;
      // if (!pattern) {
      let url = window.location.toString();
      url.replace(/[\?#&].*$/, "");
      let qrstring = url + "#" + txferstring;
      // console.log(qrstring);
      getqr(qrstring);
      // }

hartcode();
    }



function hartcode(text="this is a secret message") {

let codeout = document.querySelector("#codeout");
codeout.innerText = "";
//codeout.style.gridArea = "11 / 1 / 11 / 10";

for (const c of text.toUpperCase().split(/ ?/)) {

let found = main.querySelectorAll(`div[data-c="${c}"]`);

if (found.length>0) {

let coords = found[Math.floor(Math.random() * found.length)];
console.log(c, coords.id);
codeout.innerHTML += "[" + coords.id.replace(/^slot/,"") + "] &nbsp; ";

} else {
console.log("NOTFOUND", c);
}
// find it in the grid

}

}


    function getqr(data) {
      let [w, h] = [250, 250];
      let qrplace = document.querySelector("#qrplace");
      let qrcode = document.createElement("a");
      qrcode.className = "qrcode";
      qrcode.href = data;
      // qrcode.style = `padding:10px;background:#fff;position:absolute;left:50;top:1em;`;
      // let theqrcode = 
      new QRCode(qrcode, {
        text: data,
        width: w,
        height: h,
        colorDark: "#000",
        colorLight: "#fff",
        correctionLovel: QRCode.CorrectLevel.L,
      });
      // console.log(qrcode);


      // input type="checkbox" class="slider" id="darkmode" checked="checked" /><label for="darkmode">Dark mode</label>
      qrplace.innerHTML = `<input type="checkbox" class="slider" id="qrtoggle" /><label for="qrtoggle">QR code</label>`;
      qrplace.append(qrcode);
    }




    function nextletter(lastchar) {
      let alpha = "ABCDEFGHKLMNOPQRSTUVWXYZ".split("");
      let loopcount = 0;
      let nextchar;
      do {
        nextchar = alpha[Math.floor(Math.random() * alpha.length)];
        // console.log("checking mark",loopcount,nextmark,centerpoint.dataset.mark);
        if (++loopcount > 5) break; // prevent infinite loop when only one mark is available
      } while (nextchar && nextchar == lastchar);
      return nextchar;
    }


    document.querySelector("#reload").onclick = function (e) {
      showchart();
      window.location.hash = "";
    };


  </script>

</body>

</html>